# Configuration Gitpod pour Android - Version la plus robuste

tasks:
  - name: Setup & Build
    init: |
      # --- ÉTAPE 1: Installer et configurer Java 17 ---
      echo "Installation de Java 17..."
      sdk install java 17.0.10-zulu
      sdk default java 17.0.10-zulu
      source "/home/gitpod/.sdkman/bin/sdkman-init.sh"
      echo "--- Java 17 est maintenant la version par défaut ---"
      
      # --- ÉTAPE 2: Installer le SDK Android ---
      echo "Téléchargement des outils Android..."
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O commandlinetools.zip
      unzip -q commandlinetools.zip -d ./android-sdk
      rm commandlinetools.zip

      mkdir -p ./android-sdk/cmdline-tools/latest
      mv ./android-sdk/cmdline-tools/* ./android-sdk/cmdline-tools/latest/

      export ANDROID_HOME=$PWD/android-sdk
      export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
      
      echo "Acceptation des licences..."
      yes | sdkmanager --licenses >/dev/null

      echo "Installation des paquets SDK..."
      sdkmanager "platforms;android-33" "build-tools;33.0.1" "platform-tools" >/dev/null
      
      echo "--- Environnement Android prêt ---"

    command: |
      # --- ÉTAPE 3: Forcer l'environnement et Compiler ---
      echo "Préparation finale de l'environnement de compilation..."
      
      # Forcer l'utilisation de Java 17 en définissant JAVA_HOME
      export JAVA_HOME="/home/gitpod/.sdkman/candidates/java/17.0.10-zulu"
      
      # Tuer tout serveur Gradle qui aurait pu démarrer avec la mauvaise version de Java
      echo "Arrêt des démons Gradle existants..."
      ./gradlew --stop
      
      # Rendre le script exécutable
      chmod +x ./gradlew
      
      echo "Lancement de la compilation de l'APK de débogage avec Java 17..."
      # Lancer la compilation avec l'option pour forcer un nouveau démon si nécessaire
      ./gradlew assembleDebug --no-daemon
      
      echo "--- COMPILATION TERMINÉE ! ---"
      echo "L'APK se trouve dans le dossier : app/build/outputs/apk/debug/"
